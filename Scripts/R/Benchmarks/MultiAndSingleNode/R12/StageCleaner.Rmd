---
title: "R Notebook"
output: html_notebook
---


```{r}
library(tidyverse)
library(lubridate)
library(plotly)

RESEARCH_HOME = "/home/and/Documents/PhD/Research"
PATH_FILES = "/Scripts/R/Benchmarks/MultiAndSingleNode/R12/dblab/"
NOHUP_FILE = "nohup10.tsv"
lines = readLines(paste0(RESEARCH_HOME, PATH_FILES, NOHUP_FILE))
lines = lines[grepl("\\|STAGES\\|", lines)]
stages0 = as_tibble(lines) %>%
  separate(value, into=c("Timestamp", "Title", "Nodes", "Cores","StageID", "Stage", "Start", "End", "nTasks", "Runtime", "CPUTime", "InputBytes", "InputRecords", "ShuffleBytes", "ShuffleRecords", "ID"), sep="\\|") %>%
  separate(ID, into=c(NA, NA, "ID"), sep="-") %>%
  mutate(ID = as.numeric(ID), Stage = str_trim(Stage)) %>%
  mutate(uStart = parse_datetime(str_replace(str_trim(Start), "GMT", "")), 
         uEnd = parse_datetime(str_replace(str_trim(End), "GMT", ""))) %>%
  mutate(Duration = as.numeric(uEnd - uStart), 
         uStart = uStart - hours(7),
         Stage = paste0(str_pad(str_trim(StageID), pad="0", side="left", width=5),"_",Stage)) %>%
  select(uStart, Nodes, Stage, Duration) %>%
  arrange(uStart)
stages0$Interval = -2
stages0$FFStage = ""
stages0$Status = ""
head(stages0, n=15)
```

```{r}
lines = readLines(paste0(RESEARCH_HOME, PATH_FILES, NOHUP_FILE))
lines = lines[grepl("\\|[1-6]\\.", lines)]
ff = as_tibble(lines) %>%
  separate(value, into=c("Timestamp", "Title", "ID", "Nodes", "Cores", "Status", "Time", "Stage", "Duration", "Load", "Interval"), sep="\\|") %>%
  separate(ID, into=c(NA, NA, "ID"), sep="-") %>%
  mutate(ID = as.numeric(ID), Stage = str_trim(Stage), Duration = as.numeric(Duration)) %>%
  mutate(uStart = parse_datetime(str_replace(Timestamp, ",", ".")), FFStage = Stage) %>%
  select(uStart, Nodes, Stage, Duration, Interval, FFStage, Status)

head(ff)
```

```{r}
stages = rbind(stages0, ff) %>% arrange(uStart)

head(stages, n=100)
```

```{r}
n = nrow(stages)
for(row in 1:5){
  print(stages[row,])
}
```

